# ğŸš€ Render Migration Guide

## Overview

This guide helps you migrate from Railway to Render.com due to Railway CLI v3 authentication issues in GitHub Actions.

**Migration Time**: ~30 minutes
**Approach**: Native GitHub Integration (recommended)
**Result**: Zero GitHub Actions complexity, automatic deployments

---

## ğŸ¯ Why Render?

| Feature | Render | Railway (Current) |
|---------|--------|-------------------|
| **GitHub Integration** | âœ… Native webhooks | âŒ CLI auth broken |
| **Monorepo Support** | âœ… Native `rootDir` | âš ï¸ Manual `cd` |
| **Auto-Deploy** | âœ… Automatic | âŒ Requires workflows |
| **Health Checks** | âœ… Built-in | âš ï¸ Manual scripts |
| **Rollback** | âœ… One-click | âŒ Manual |
| **Setup Complexity** | âœ… Simple | âŒ Complex tokens |

---

## ğŸ“‹ Pre-Migration Checklist

### 1. Export Railway Configuration

```bash
# Save these values from Railway dashboard:
# - Database URLs (PostgreSQL, Redis)
# - Environment variables for each service
# - Service IDs (if needed later)

# From Railway project settings:
RAILWAY_DATABASE_URL="postgresql://..."
RAILWAY_REDIS_URL="redis://..."
RAILWAY_JWT_SECRET="..."
RAILWAY_SESSION_SECRET="..."
```

### 2. Verify Docker Builds Locally

```bash
# Test each service builds correctly
cd /Users/dorianhryniewicki/GitHub/Sepulki

# Hammer Orchestrator
docker build -f services/hammer-orchestrator/Dockerfile.railway -t hammer-test .

# Local Auth
docker build -f services/local-auth/Dockerfile.railway -t auth-test .

# Video Stream Proxy
docker build -f services/video-stream-proxy/Dockerfile -t video-test .
```

---

## ğŸš€ Step 1: Create Render Account (5 minutes)

1. **Sign up**: https://dashboard.render.com/register
2. **Connect GitHub**:
   - Click "New +" â†’ "Blueprint"
   - Click "Connect GitHub"
   - Authorize Render to access your repositories
   - Select the `Sepulki` repository

---

## ğŸ“„ Step 2: Deploy render.yaml (10 minutes)

### Commit the Configuration

The `render.yaml` file has been created at the repository root.

```bash
cd /Users/dorianhryniewicki/GitHub/Sepulki

# Review the configuration
cat render.yaml

# Commit to repository
git add render.yaml
git commit -m "feat: add Render deployment configuration

Migrating from Railway to Render due to CLI v3 authentication issues.

Configuration includes:
- hammer-orchestrator service
- local-auth service
- video-stream-proxy service
- Monorepo support with rootDir
- Build filtering for efficient deployments
- Health check endpoints
- Auto-deploy from master branch

ğŸ¤– Generated with [Claude Code](https://claude.com/claude-code)

Co-Authored-By: Claude <noreply@anthropic.com>"

git push origin master
```

### Deploy in Render Dashboard

1. Go to https://dashboard.render.com
2. Click "New +" â†’ "Blueprint"
3. Select your repository
4. Render will detect `render.yaml`
5. Review the services to be created:
   - âœ… hammer-orchestrator
   - âœ… local-auth
   - âœ… video-stream-proxy
6. Click **"Apply"**
7. Monitor deployment progress

---

## âš™ï¸ Step 3: Configure Environment Variables (10 minutes)

For each service, add sensitive environment variables in Render dashboard:

### Hammer Orchestrator

```
Dashboard â†’ hammer-orchestrator â†’ Environment
```

Add these variables:
- `DATABASE_URL` = (your PostgreSQL connection string)
- `REDIS_URL` = (your Redis connection string)

**Note**: `JWT_SECRET` and `SESSION_SECRET` are auto-generated by Render.

### Local Auth

```
Dashboard â†’ local-auth â†’ Environment
```

Add these variables:
- `DATABASE_URL` = (your PostgreSQL connection string)
- `REDIS_URL` = (your Redis connection string)

### Video Stream Proxy

```
Dashboard â†’ video-stream-proxy â†’ Environment
```

Add these variables:
- `ISAAC_SIM_IP` = (your Isaac Sim server IP)

### After Adding Variables

Click **"Save Changes"** - this will trigger a redeployment with the new environment variables.

---

## ğŸ” Step 4: Verify Deployments (5 minutes)

### Check Health Endpoints

```bash
# Wait for deployments to complete (check Render dashboard)
# Then test each service:

# Hammer Orchestrator
curl https://hammer-orchestrator.onrender.com/health

# Local Auth
curl https://local-auth.onrender.com/health

# Video Stream Proxy
curl https://video-stream-proxy.onrender.com/health

# Expected response for all: {"status":"ok"} or similar
```

### Test GraphQL Endpoint

```bash
# Test GraphQL introspection
curl -X POST https://hammer-orchestrator.onrender.com/graphql \
  -H "Content-Type: application/json" \
  -d '{"query": "{ __typename }"}'

# Expected response: {"data":{"__typename":"Query"}}
```

---

## ğŸŒ Step 5: Update Frontend Configuration (5 minutes)

Update Vercel environment variables to point to new Render URLs:

```bash
# In Vercel dashboard or via CLI:

# Production environment
gh secret set NEXT_PUBLIC_API_URL_PROD --body "https://hammer-orchestrator.onrender.com"
gh secret set NEXT_PUBLIC_GRAPHQL_ENDPOINT_PROD --body "https://hammer-orchestrator.onrender.com/graphql"
gh secret set NEXT_PUBLIC_WS_ENDPOINT_PROD --body "wss://hammer-orchestrator.onrender.com/graphql"

# Or update in Vercel dashboard:
# Settings â†’ Environment Variables â†’ Edit Production
```

Update `render.yaml` CORS origins if needed:
```yaml
- key: CORS_ORIGIN
  value: https://your-vercel-app.vercel.app
```

---

## âœ… Step 6: Test End-to-End (5 minutes)

1. **Visit your frontend**: https://sepulki-forge-2ex4yvbuu-monermakers.vercel.app
2. **Test authentication**: Try logging in
3. **Test GraphQL queries**: Check if data loads
4. **Test video streaming**: Verify video proxy works
5. **Check browser console**: Look for any API errors

---

## ğŸ‰ Step 7: Enable Auto-Deployment

Auto-deployment is already enabled via `render.yaml`:

```yaml
autoDeploy: true
branch: master
```

**Test it**:
1. Make a small change to any service
2. Commit and push to master
3. Check Render dashboard - deployment should start automatically
4. Only changed services rebuild (thanks to `buildFilter`)

---

## ğŸ”„ Optional: Database Migration

### Option A: Keep Railway Databases

Your services can continue using Railway databases:
- Render services can connect to external databases
- Update `DATABASE_URL` and `REDIS_URL` to Railway values
- No data migration needed

### Option B: Migrate to Render Databases

Uncomment database section in `render.yaml`:

```yaml
databases:
  - name: sepulki-postgres
    plan: starter
    databaseName: sepulki
    user: sepulki_user
    region: oregon
```

Then migrate data:
```bash
# Export from Railway
railway run pg_dump $DATABASE_URL > backup.sql

# Import to Render
# Get connection string from Render dashboard
psql $RENDER_DATABASE_URL < backup.sql
```

---

## ğŸ—‘ï¸ Step 8: Decommission Railway (After 1 Week)

**Wait 1 week** to ensure Render is stable, then:

1. Download any final logs from Railway
2. Backup any persistent data
3. Delete Railway services:
   - Railway Dashboard â†’ Project Settings â†’ Delete Project
4. Remove Railway secrets from GitHub:
   ```bash
   gh secret delete RAILWAY_TOKEN
   gh secret delete RAILWAY_PROJECT_ID
   gh secret delete RAILWAY_SERVICE_HAMMER_ID
   gh secret delete RAILWAY_SERVICE_AUTH_ID
   gh secret delete RAILWAY_SERVICE_VIDEO_PROXY_ID
   gh secret delete RAILWAY_ENVIRONMENT_PROD_ID
   gh secret delete RAILWAY_ENVIRONMENT_DEV_ID
   ```

---

## ğŸ› ï¸ Troubleshooting

### Build Failures

**Issue**: Service fails to build

**Solution**:
1. Check build logs in Render dashboard
2. Verify `dockerContext` is set to `../..`
3. Ensure Dockerfile paths are correct
4. Test Docker build locally first

### Health Check Failures

**Issue**: Deployment completes but health check fails

**Solution**:
1. Check service logs in Render dashboard
2. Verify environment variables are set
3. Check database connectivity
4. Ensure health endpoint exists (`/health`)

### CORS Errors

**Issue**: Frontend can't connect to backend

**Solution**:
1. Update `CORS_ORIGIN` in render.yaml
2. Redeploy services
3. Check browser console for specific error
4. Verify frontend URL is correct

### Database Connection Issues

**Issue**: "Cannot connect to database"

**Solution**:
1. Verify `DATABASE_URL` is set correctly
2. Check database is running
3. Verify IP allowlist if using external DB
4. Test connection string locally

---

## ğŸ“Š Post-Migration Checklist

- [ ] All 3 services deployed successfully
- [ ] Health endpoints return 200 OK
- [ ] GraphQL endpoint responds correctly
- [ ] Frontend connects to new backend URLs
- [ ] Authentication flow works
- [ ] Database connectivity verified
- [ ] Redis connectivity verified
- [ ] Auto-deployment tested (make commit, verify deployment)
- [ ] Build filtering works (only changed services rebuild)
- [ ] Environment variables configured
- [ ] CORS configured correctly
- [ ] Video streaming functional
- [ ] Monitoring/logging reviewed
- [ ] Custom domains configured (if needed)
- [ ] Team notified of new URLs

---

## ğŸ”— Useful Links

- **Render Dashboard**: https://dashboard.render.com
- **Render Documentation**: https://render.com/docs
- **Blueprint Spec**: https://render.com/docs/blueprint-spec
- **Monorepo Support**: https://render.com/docs/monorepo-support
- **Health Checks**: https://render.com/docs/health-checks
- **Environment Variables**: https://render.com/docs/environment-variables

---

## ğŸ’° Pricing

### Render Starter Plan (Per Service)
- **Cost**: $7/month per service
- **Resources**: 0.5 GB RAM, shared CPU
- **Total for 3 services**: $21/month

### Free Tier
- **750 hours/month** shared across all services
- If your services run 24/7, you'll need paid plans
- Good for testing before committing to paid plans

### Cost Optimization
- Use environment groups to share configuration
- Enable build filtering (already configured)
- Use same region for all services (oregon)
- Monitor usage in Render dashboard

---

## ğŸ“ Key Differences from Railway

1. **No CLI Required**: Everything via dashboard or render.yaml
2. **Predictable Pricing**: Fixed monthly cost per service
3. **Native Monorepo**: `rootDir` handles service directories
4. **Build Filtering**: Only rebuilds when specific paths change
5. **Zero-Downtime Deploys**: Health checks prevent bad deployments
6. **PR Previews**: Automatic preview environments (can be enabled)
7. **One-Click Rollback**: Easy rollback to previous deployment

---

## âœ… Success!

Once you see:
- âœ… All services showing "Live" in Render dashboard
- âœ… Health endpoints returning 200
- âœ… Frontend connecting successfully
- âœ… Auto-deploy working on git push

**You're done!** Render is now handling your deployments automatically.

---

**Migration Date**: 2025-11-07
**Status**: Ready to deploy
**Next Step**: Run Step 1 (Create Render account)
